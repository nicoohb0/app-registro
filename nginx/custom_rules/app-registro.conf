# ========================================
# REGLAS DE EXCLUSIÓN PARA APP-REGISTRO
# ========================================
# Fecha: 18/02/2026
# Autor: Tu Nombre
# Descripción: Exclusiones para falsos positivos en aplicación de registro
# ========================================

# -------------------------------------------------------
# EXCLUSIÓN 1: Campo 'clave' en endpoints de registro
# -------------------------------------------------------
# ID Regla afectada: 942100, 942101, 942190, 949110
# Tipo: SQL Injection / Anomaly Score
# Justificación: Los caracteres especiales en contraseñas legítimas
# (como !@#$%^&*) activan falsamente las reglas SQLi
# -------------------------------------------------------
SecRule REQUEST_URI "@contains /api/registro" \
    "id:20001,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=942100;ARGS:clave,\
    ctl:ruleRemoveTargetById=942101;ARGS:clave,\
    ctl:ruleRemoveTargetById=942190;ARGS:clave,\
    ctl:ruleRemoveTargetById=949110;ARGS:clave"

# -------------------------------------------------------
# EXCLUSIÓN 2: Endpoint de validación de contraseñas
# -------------------------------------------------------
# ID Regla afectada: 942100, 942101, 942190
# Tipo: SQL Injection
# Justificación: Este endpoint recibe contraseñas para validar
# su fortaleza, y debe permitir todos los caracteres especiales
# -------------------------------------------------------
SecRule REQUEST_URI "@contains /api/registro/validate-password" \
    "id:20002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,942101,942190,949110"

# -------------------------------------------------------
# EXCLUSIÓN 3: Endpoint de verificación de contraseñas comunes
# -------------------------------------------------------
# ID Regla afectada: 942100, 942101
# Tipo: SQL Injection
# Justificación: Similar al anterior, recibe contraseñas para
# verificar si están en la lista negra
# -------------------------------------------------------
SecRule REQUEST_URI "@contains /api/registro/check-common-password" \
    "id:20003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,942101"

# -------------------------------------------------------
# EXCLUSIÓN 4: Formulario HTML de registro
# -------------------------------------------------------
# ID Regla afectada: 941100, 941101
# Tipo: XSS (Cross-Site Scripting)
# Justificación: El formulario contiene atributos data-* de Bootstrap
# que activan falsamente reglas XSS
# -------------------------------------------------------
SecRule REQUEST_URI "@contains /registro-form" \
    "id:20004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,941101"

# ========================================
# PROTECCIÓN CONTRA EXFILTRACIÓN DE DATOS
# ========================================
# Estas reglas NO son exclusiones, son protecciones adicionales
# ========================================

# -------------------------------------------------------
# REGLA 10001: Path Traversal
# -------------------------------------------------------
# Detecta y bloquea intentos de acceder a archivos del sistema
# Patrones: ../../../etc/passwd, ..\windows\win.ini
# -------------------------------------------------------
SecRule REQUEST_URI|ARGS "@rx \.\./|\.\.\\|/etc/passwd|/windows/win.ini" \
    "id:10001,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Path Traversal Attack Blocked',\
    tag:'EXFILTRATION'"

# -------------------------------------------------------
# REGLA 10002: Números de Tarjeta de Crédito
# -------------------------------------------------------
# Detecta posibles números de tarjeta en respuestas (13-16 dígitos)
# -------------------------------------------------------
SecRule RESPONSE_BODY "@rx \b(?:\d[ -]*?){13,16}\b" \
    "id:10002,\
    phase:4,\
    deny,\
    status:403,\
    msg:'Credit Card Number Leak Prevention',\
    tag:'EXFILTRATION'"

# -------------------------------------------------------
# REGLA 10003: DNI/NIF (Documento Nacional de Identidad)
# -------------------------------------------------------
# Detecta patrones de DNI argentino/español en respuestas
# Formato: XX.XXX.XXX o XXXXXXXX
# -------------------------------------------------------
SecRule RESPONSE_BODY "@rx \b\d{1,2}\.\d{3}\.\d{3}\b" \
    "id:10003,\
    phase:4,\
    deny,\
    status:403,\
    msg:'DNI/NIF Leak Prevention',\
    tag:'EXFILTRATION'"

# -------------------------------------------------------
# REGLA 10004: Stack Traces
# -------------------------------------------------------
# Detecta errores de JavaScript que exponen rutas del sistema
# -------------------------------------------------------
SecRule RESPONSE_BODY "@rx at\s+[\w\.]+\([\w\.]+\.js:\d+:\d+\)" \
    "id:10004,\
    phase:4,\
    deny,\
    status:403,\
    msg:'JavaScript Stack Trace Detected',\
    tag:'EXFILTRATION'"

# -------------------------------------------------------
# REGLA 10005: MongoDB ObjectIDs
# -------------------------------------------------------
# Previene exposición de IDs internos de MongoDB
# -------------------------------------------------------
SecRule RESPONSE_BODY "@rx _id\"\s*:\s*\"[a-f0-9]{24}\"" \
    "id:10005,\
    phase:4,\
    deny,\
    status:403,\
    msg:'MongoDB ObjectID Exposure',\
    tag:'EXFILTRATION'"

# ========================================
# FIN DE REGLAS
# ========================================